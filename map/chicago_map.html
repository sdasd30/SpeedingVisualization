<html>
  <!DOCTYPE html>
<meta charset="utf-8">
  <style>
  .background{
    fill:#fff;
    }
    #zips {
      stroke: black;
    }
    #zips-line{
      fill: beige;
    }
   .active{
      fill: none;
    }
    body {
      display: flex;
      flex-flow: row nowrap;
    }


  </style>

  <body>

    <div id="map"></div>
    <div id="stacked">
      <select onchange="getVal()" name="timeOptions" id="options">
        <option value="Repeat Offenders">Repeat Offenders</option>
        <option value="Repeat Offenders Within Past 6 Months">
          Repeat Offenders Within Past 6 Months
        </option>
        <option value="Repeat Offenders Within The Year">
          Repeat Offenders Within The Year
        </option>
        <option value="Repeat Offenders Within The Month">
          Repeat Offenders Within The Month
        </option>
      </select>
      <div id="chart"></div>
    </div>

    <!-- d3 v7 integration -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- d3 topojson -->
    <script src="http://d3js.org/topojson.v1.min.js"></script>

    <script>
    var map = {60630:4.580018619594385,
    60641:2.606144343302991,
    60628:1.2654764480171246,
    60614:1.638268625714024,
    60637:1.7735330180416886,
    60610:1.8990802517205818,
    60622:1.155377228178649,
    60618:0.8849480880719737,
    60620:0.9662240151100022,
    60609:1.0207753966955668,
    60604:989.3717948717949,
    60617:0.7414007976071785,
    60623:0.6032234798047048,
    60653:1.7072343632253202,
    60608:0.6174409550999221,
    60617:0.5850677135260884,
    60605:4.349030024953715,
    60629:0.4397283829309377,
    60634:0.6457580497276306,
    60076:1.3417640875354377,
    60632:0.47314934286399396,
    60636:0.722376630191833,
    60659:0.893883284382582,
    60645:0.7836052220738964,
    60624:0.7560628299778737,
    60402:0.5226609702051682,
    60625:0.3361867959847183,
    60651:0.37604887668690307,
    60646:1.016397690257625,
    60613:0.5361438632586848,
    60660:0.5236768218581067,
    60620:0.28643714075853144,
    60612:0.6357725717294025,
    60656:0.8878690699988941,
    60611:0.7725284669331122,
    60649:0.34861280849278586,
    60632:0.2117222558434292,
    60605:1.2172583111969733,
    60625:0.1623518078619829,
    60619:0.19206808692288196,
    60631:0.4955604883462819,
    60642:0.691595265217176,
    60652:0.33670704902111126,
    60302:0.41621262037506335,
    60649:0.236999069733506,
    60657:0.18842923235862194,
    60607:0.6701388888888888,
    60659:0.2578470182607585,
    60655:0.3414784817077356,
    60637:0.1582939218777369,
    60644:0.14829238558052119,
    60618:0.07610013551101918,
    60639:0.07596475562393089,
    60640:0.07856274483317574,
    60621:0.1196910384307783,
    60639:0.044066228442943056,
    60707:0.05420181929584767,
    60654:0.08980395925427638,
    62656:0.07989326636320829}
    var tip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)


      let width = 800,
        height = 800;
      active = d3.select(null);

    let projection = d3.geoMercator()
        .scale(width * 90)
        .center([-87.6298, 41.8781])
        .translate([width / 2, height / 2]);
      let path = d3.geoPath(projection);

      
    let svg = d3.select("#map").append("svg")
        .attr("width", width)
        .attr("height", height);

      svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
      .on("click", reset)

      let g = svg.append("g");




      let geoChicago, chicago;
      let offenderData;
      let currTimeScale = "Repeat Offenders";
      colorScheme = d3.schemeBlues[5];

    colorScale = d3.scaleThreshold()
        .domain([0, 0.5, 1, 5, 1000])
        .range(colorScheme);

      function drawCameras() {
        g.selectAll("circle")
          .data(
            cameras.map((d) => {
              
              return {
                pos: [d.LONGITUDE, d.LATITUDE],
                add: d.ADDRESS,
              };
            })
          )

          .enter()
          .append("circle")
          .attr("id", "cameras")
          .attr("r", 1)
          .attr("transform", (d) => "translate(" + projection(d.pos) + ")")
          .attr("fill", "red")
          .on("click", showStack)
          .on("mouseover", showTooltip )
          .on("mousemove", moveTooltip )
          .on("mouseleave", hideTooltip );
      }
      
      function drawStreets(){
        g.selectAll("g.streets path")
          .data(streets.features)
          .enter()
          .append("path")
          .attr("id", "streets")
          .attr("stroke", "blue")
          .attr("d", d3.geoPath(projection));
      }

      function drawAreas() {
        g.selectAll("g.zips path")
          .data(geoChicago.features)
          .enter()
          .append("path")
          .attr("id", "zips")
        .attr("fill", d => map[d.properties.zip] == null ? "#ccc" : colorScale(map[d.properties.zip]))
          .attr("stroke", "black")
          .attr("d", d3.geoPath(projection))
        .on("click", clicked)
      }
      function drawZips() {
        g.append("path")
          .attr("id", "zips-line")
        .datum(topojson.mesh(chicago, chicago, function(a,b){return a!=b}))
          .attr("d", d3.geoPath(projection));
      }

      function clicked(event, d) {
        if (d3.select(".background").node() === this) return reset();
        if (active.node() === this) return reset();

        active.classed("active", false);
        active = d3.select(this).classed("active", true);

      var b = path.bounds(d)
      var dx = b[1][0]-b[0][0], dy = b[1][1]-b[0][1], x = (b[0][0]+b[1][0])/2, y = (b[1][1]+b[0][1])/2;
      var scale = .5 / Math.max(dx / width, dy / height),
      translate = [width/2 - scale*x , height/2 - scale *y]

        g.transition()
          .duration(750)
          .style("stroke-width", 1.5 / scale + "px")
        .attr("transform", "translate(" + translate + ")scale(" + scale + ")")
        
      }

      function reset() {
        active.classed("active", false);
        active = d3.select(null);

        g.transition().delay(100).duration(750).attr("transform", "");
        d3.select("#chart").selectAll("*").remove();
      }
      function drawChart(camera, timeScale) {
        d3.select("#chart").selectAll("*").remove();
        let graphData = offenderData.filter((d) => {
          if (camera) {
            return d.Camera.toLowerCase() == camera.toLowerCase();
          } else {
            return d.Camera == "10318 S INDIANAPOLIS";
          }
        });
        console.log('data with given ', graphData)
        if (timeScale == undefined) {
          timeScale = "Repeat Offenders";
        }

        // set the dimensions and margins of the graph
        var margin = { top: 60, right: 230, bottom: 50, left: 50 },
          width = 800 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        // List of groups = header of the csv files
        var keys = ["New Offenders This Month", timeScale];
        // color palette
        var color = d3.scaleOrdinal().domain(keys).range(d3.schemeSet2);
        //stack the data
        var stackGen = d3.stack().keys(keys);

        var stackedData = stackGen(graphData);

        // Add X axis
        var range = d3.extent(graphData, function (d) {
          return new Date(d.Year, d.Month);
        });
        var x = d3.scaleTime().domain(range).range([0, width]);
        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x));
        var yrange = d3.extent(graphData, function (d) {
          return Number(d["New Offenders This Month"]) + Number(d[timeScale]);
        });

        // Add Y axis
        var y = d3.scaleLinear().domain(yrange).range([height, 0]);
        svg.append("g").call(d3.axisLeft(y).ticks(5));
        // Show the areas

        var areaChart = svg.append("g");

        // Area generator
        var area = d3
          .area()
          .x((d) => {
            return x(new Date(d.data.Year, d.data.Month));
          })
          .y0(function (d) {
            return y(d[0]);
          })
          .y1(function (d) {
            return y(d[1]);
          });
        areaChart
          .selectAll("mylayers")
          .data(stackedData)
          .enter()
          .append("path")
          .attr("class", function (d) {
            return "myArea " + d.key;
          })
          .attr("d", area)
          .style("fill", function (d) {
            return color(d.key);
          });
      }
      function showStack(event, d) {
        console.log("camera clicked: ", d, d.add.slice(0, -15));
        currCamera = d.add.slice(0, -15);
        drawChart(d.add.slice(0, -15), currTimeScale);
      }
      function getVal() {
        currTimeScale = document.getElementById("options").value;
        drawChart(currCamera, currTimeScale);
      }
      
  const tooltip = d3.select("#map")
    .append("div")
      .style("opacity", 0)
      .attr("class", "tooltip")
      .style("position", "absolute")
      .style("background-color", "black")
      .style("border-radius", "5px")
      .style("padding", "10px")
      .style("color", "white")

  const showTooltip = function(event, d) {
    tooltip
      .transition()
      .duration(200)
    tooltip
      .style("opacity", 1)
      .html("Address: " + d.add)
      .style("left", (event.x)/2 + "px")
      .style("top", (event.y)/2+30 + "px")
  }
  const moveTooltip = function(event, d) {
    tooltip
      .style("left", (event.x)/2 + "px")
      .style("top", (event.y)/2+10 + "px")
  }
  const hideTooltip = function(event, d) {
    tooltip
      .transition()
      .duration(200)
      .style("opacity", 0)
  }

      async function ready() {
        // load files async; store the values so we can use them later
        chicago = await d3.json("chicago_zips_topojson.json");
        streets = await d3.json("streets.json")
        geoChicago = await d3.json("Boundaries - ZIP Codes_geo.json");
        cameras = await d3.csv("Speed_Camera_Locations.csv");
        offenderData = await d3.csv("out.csv");
        drawStreets();
        drawCameras();
        drawAreas();
        drawZips();

      }

      // call the function that draws
      ready();


    </script>

  </body>

</html>